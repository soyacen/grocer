apiVersion: batch/v1
kind: CronJob
metadata:
  name: grocer-cronjob
  namespace: default
  labels:
    app: grocer-cronjob
  annotations:
    description: "定时任务grocer-cronjob，*/1 * * * *"
spec:
  schedule: "*/1 * * * *"  
  concurrencyPolicy: Forbid  
  startingDeadlineSeconds: 300 
  successfulJobsHistoryLimit: 3 
  failedJobsHistoryLimit: 1 
  jobTemplate:
    spec:
      backoffLimit: 4 
      ttlSecondsAfterFinished: 3600 
      template:
        metadata:
          labels:
            app: grocer-cronjob
        spec:
          automountServiceAccountToken: false  
          enableServiceLinks: false 
          restartPolicy: OnFailure  
          securityContext:
            runAsNonRoot: true
            runAsUser: 65532
            runAsGroup: 65532
            fsGroup: 65532
            seccompProfile:
              type: RuntimeDefault
          imagePullSecrets:
          - name: regcred  
          containers:
          - name: grocer-cronjob
            image: soyacen/grocer:v0.0.1  
            imagePullPolicy: IfNotPresent  
            command: ["/app/app"]
            args: ["cronjob"]
            env:
            - name: ENV
              value: "production"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
            livenessProbe:
              exec:
                command:
                - /bin/sh
                - -c
                - "echo alive"
              initialDelaySeconds: 30
              periodSeconds: 60
          dnsPolicy: ClusterFirst
